<html>
    <head>
        <meta charset="UTF-8" />
        <title>Three.js with WebSocket</title>
        <link rel="stylesheet" href="css/buttons.css"/>
    </head>
    <body>
        <script type="text/javascript">
        var ws;
        var url;
        function connect() {
            url = document.getElementById("server_url").value;
            if ("WebSocket" in window) {
                ws = new WebSocket(url);
            } else if ("MozWebSocket" in window) {
                ws = new MozWebSocket(url);
            } else {
                document.getElementById("messages").innerHTML += "This Browser does not support WebSockets<br />";
                return;
            }
            ws.onopen = function(e) {
                document.getElementById("messages").innerHTML += "Client: A connection to "+ws.url+" has been opened.<br />";
                document.getElementById("server_url").disabled = true;
                document.getElementById("toggle_connect").innerHTML = "Disconnect";
            };

            ws.onerror = function(e) {
                document.getElementById("messages").innerHTML += "Client: An error occurred, see console log for more details.<br />";
                console.log(e);
            };

            ws.onclose = function(e) {
                document.getElementById("messages").innerHTML += "Client: The connection to "+url+" was closed. ["+e.code+(e.reason != "" ? ","+e.reason : "")+"]<br />";
                cleanup_disconnect();
            };
            ws.onmessage = function(e) {
                document.getElementById("messages").innerHTML = "Server: "+e.data+"<br/>";
                if (typeof(e.data)==="string")
                {
                    //console.log(e.data);
                    var obj = JSON && JSON.parse(e.data) || $.parseJSON(e.data);
                    for (i=0;i<obj.length;++i)
                    {
                        if (obj[i].type === 'attitude')
                        {
                            console.log(obj[i].type);
                            console.log(obj[i].var.x);
                            render_(obj[i].name,
                                    obj[i].var.x,
                                    obj[i].var.y,
                                    obj[i].var.z,
                                    obj[i].var.qr,
                                    obj[i].var.qi,
                                    obj[i].var.qj,
                                    obj[i].var.qk);
                            appendSmoothie(obj[i].var.u,obj[i].var.v,obj[i].var.w,
                                           obj[i].var.p,obj[i].var.q,obj[i].var.r);
                        }
                    }
                }
                else
                {
                    //var bytes = new Float64Array(buffer);
                }
            };
        }

        function disconnect() {
            ws.close();
            cleanup_disconnect();
        }

        function cleanup_disconnect() {
            document.getElementById("server_url").disabled = false;
            document.getElementById("toggle_connect").innerHTML = "Connect";
            document.getElementById("messages").innerHTML += "Disconnected";
        }

        function toggle_connect() {
            if (document.getElementById("server_url").disabled === false) {
                connect();
            } else {
                disconnect();
            }
        }
        </script>
        <div id="controls">
            <div id="server">
                <input type="text" name="server_url" id="server_url" value="ws://localhost:9002" /><br />
                <button id="toggle_connect" onclick="toggle_connect();">Connect</button>
            </div>
        </div>
        <div id="messages"></div>
        <button class="myButton"
            onclick="reset()">RESET</button>
        <form method="post" onsubmit="f(document.getElementById('xval').value,document.getElementById('yval').value,document.getElementById('zval').value);return false;">
                X<input type="text" id="xval" value=0>
                Y<input type="text" id="yval" value=0>
                Z<input type="text" id="zval" value=0>
                <input type="submit" class "myButton" value="Submit">
                </form>
        <canvas id="canvasUVW" width="400" height="100"></canvas>
        <canvas id="canvasPQR" width="400" height="100"></canvas>

        <script type="text/javascript" src="js/three.min.js"></script>
        <script type="text/javascript" src="js/Detector.js"></script>
        <script type="text/javascript" src="js/TrackballControls.js"></script>
        <script type="text/javascript" src="js/STLLoader.js"></script>
        <script type="text/javascript" src="js/OBJLoader.js"></script>
        <script type="text/javascript" src="js/Car.js"></script>
        <script type="text/javascript" src="js/smoothie.js"></script>
        <script type="text/javascript" src="js/test.js"></script>
        <script type="text/javascript" src="js/testSmoothie.js"></script>
    </body>
</html>
