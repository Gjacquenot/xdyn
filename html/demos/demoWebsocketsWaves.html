<html>
    <head>
        <meta charset="UTF-8" />
        <title>WebSocket</title>
    </head>
    <body>
        <p>Demo where this page received a vector of dict that contains a wave elevation</p>
        <p>The console displays the first value of the wave mesh elevation</p>
        <script type="text/javascript" src="../js/third_party/Base91/base91Float32.js"></script>
        <script type="text/javascript">
        var ws;
        var url;
        function connect() {
            url = document.getElementById("server_url").value;
            if ("WebSocket" in window) {
                ws = new WebSocket(url);
            } else if ("MozWebSocket" in window) {
                ws = new MozWebSocket(url);
            } else {
                document.getElementById("messages").innerHTML += "This Browser does not support WebSockets<br />";
                return;
            }
            ws.onopen = function(e) {
                document.getElementById("messages").innerHTML += "Client: A connection to "+ws.url+" has been opened.<br />";
                document.getElementById("server_url").disabled = true;
                document.getElementById("toggle_connect").innerHTML = "Disconnect";
            };

            ws.onerror = function(e) {
                document.getElementById("messages").innerHTML += "Client: An error occurred, see console log for more details.<br />";
                console.log(e);
            };

            ws.onclose = function(e) {
                document.getElementById("messages").innerHTML += "Client: The connection to "+url+" was closed. ["+e.code+(e.reason != "" ? ","+e.reason : "")+"]<br />";
                cleanup_disconnect();
            };
            ws.onmessage = function(e) {
                //document.getElementById("messages").innerHTML = "Server: "+e.data+"<br/>";
                if (typeof(e.data)==="string")
                {
                    //console.log(e.data);
                    var obj = JSON && JSON.parse(e.data) || $.parseJSON(e.data);
                    for (i=0;i<obj.length;++i)
                    {
                        if (obj[i].type === 'waves')
                        {
                            //console.log(obj[i].z);
                            var ba = base91Float32.decode(obj[i].z);
                            console.log(ba[0]);
                        }
                    }
                }
                else
                {
                    console.log("Binary message");
                    //var bytes = new Float32Array(buffer);
                }
            };
        }

        function disconnect() {
            ws.close();
            cleanup_disconnect();
        }

        function cleanup_disconnect() {
            document.getElementById("server_url").disabled = false;
            document.getElementById("toggle_connect").innerHTML = "Connect";
            document.getElementById("messages").innerHTML += "Disconnected";
        }

        function toggle_connect() {
            if (document.getElementById("server_url").disabled === false) {
                connect();
            } else {
                disconnect();
            }
        }
        </script>
        <div id="controls">
            <div id="server">
                <input type="text" name="server_url" id="server_url" value="ws://localhost:9002" /><br />
                <button id="toggle_connect" onclick="toggle_connect();">Connect</button>
            </div>
        </div>
        <div id="messages"></div>
    </body>
</html>
